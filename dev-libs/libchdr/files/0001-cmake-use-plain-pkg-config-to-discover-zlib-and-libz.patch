From d4362826689ef0a849bae749eef70249835432cd Mon Sep 17 00:00:00 2001
From: Tobias Jakobi <tjakobi@math.uni-bielefeld.de>
Date: Mon, 3 Mar 2025 16:07:26 +0100
Subject: [PATCH 1/2] cmake: use plain pkg-config to discover zlib and libzstd

Signed-off-by: Tobias Jakobi <tjakobi@math.uni-bielefeld.de>
---
 CMakeLists.txt | 30 ++++++++----------------------
 1 file changed, 8 insertions(+), 22 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index fde6faf..6114214 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -38,28 +38,13 @@ add_subdirectory(deps/lzma-24.05 EXCLUDE_FROM_ALL)
   list(APPEND CHDR_LIBS lzma)
   list(APPEND CHDR_INCLUDES lzma)
 
-# zlib
-if (WITH_SYSTEM_ZLIB)
-  find_package(ZLIB REQUIRED)
-  list(APPEND PLATFORM_LIBS ZLIB::ZLIB)
-else()
-  option(ZLIB_BUILD_EXAMPLES "Enable Zlib Examples" OFF)
-  add_subdirectory(deps/zlib-1.3.1 EXCLUDE_FROM_ALL)
-  set_target_properties(zlibstatic PROPERTIES POSITION_INDEPENDENT_CODE ON)
-  list(APPEND CHDR_LIBS zlibstatic)
-endif()
+find_package(PkgConfig)
+
+pkg_check_modules(ZLIB REQUIRED zlib>=1.3.1)
+pkg_check_modules(ZSTD REQUIRED libzstd>=1.5.6)
+
+list(APPEND PLATFORM_LIBS ${ZLIB_LIBRARIES} ${ZSTD_LIBRARIES})
 
-# zstd
-if (WITH_SYSTEM_ZSTD)
-  find_package(zstd REQUIRED)
-  list(APPEND PLATFORM_LIBS zstd::libzstd_shared)
-else()
-  option(ZSTD_BUILD_SHARED "BUILD SHARED LIBRARIES" OFF)
-  option(ZSTD_BUILD_PROGRAMS "BUILD PROGRAMS" OFF)
-  option(ZSTD_LEGACY_SUPPORT "LEGACY SUPPORT" OFF)
-  add_subdirectory(deps/zstd-1.5.6/build/cmake EXCLUDE_FROM_ALL)
-  list(APPEND CHDR_LIBS libzstd_static)
-endif()
 #--------------------------------------------------
 # chdr
 #--------------------------------------------------
@@ -90,8 +75,9 @@ endif()
 
 if (BUILD_SHARED_LIBS)
   add_library(chdr SHARED ${CHDR_SOURCES})
-  target_include_directories(chdr PRIVATE ${CHDR_INCLUDES} PUBLIC include)
+  target_include_directories(chdr PRIVATE ${CHDR_INCLUDES} PUBLIC include ${ZLIB_INCLUDE_DIRS} ${ZSTD_INCLUDE_DIRS})
   target_link_libraries(chdr PRIVATE ${CHDR_LIBS} ${PLATFORM_LIBS})
+  target_compile_options(chdr PUBLIC ${ZLIB_CFLAGS_OTHER} PUBLIC ${ZSTD_CFLAGS_OTHER})
 
   if(MSVC)
     target_compile_definitions(chdr PUBLIC "CHD_DLL")
-- 
2.45.3

